---
title: Cursor
description: API reference for FindCursor, HttpFindCursor, AggregationCursor, and related cursor classes
---

# Cursor

Cursors provide lazy evaluation and iteration over query results. mongo.do includes several cursor types for different operations.

## Import

```typescript
import {
  FindCursor,
  HttpFindCursor,
  HttpAggregationCursor,
  AggregationCursor
} from 'mongo.do'
```

## Cursor Types

| Cursor | Description |
|--------|-------------|
| `FindCursor` | In-memory cursor for find operations |
| `HttpFindCursor` | HTTP-based cursor for find operations (Durable Objects mode) |
| `AggregationCursor` | In-memory cursor for aggregation operations |
| `HttpAggregationCursor` | HTTP-based cursor for aggregation (Durable Objects mode) |

---

## FindCursor / HttpFindCursor

Cursors returned by `collection.find()` provide lazy evaluation of MongoDB queries.

### Type Parameters

```typescript
FindCursor<TSchema extends Document = Document>
HttpFindCursor<TDocument extends Document = Document>
```

### Properties

#### closed

```typescript
get closed(): boolean
```

Whether the cursor is closed.

#### bufferedCount

```typescript
get bufferedCount(): number
```

Number of documents currently buffered.

---

### Chainable Modifiers

All modifier methods return `this` for chaining.

#### sort()

Set the sort order for documents.

```typescript
sort(spec: Record<string, 1 | -1>): this
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `spec` | `Record<string, 1 \| -1>` | Sort specification (1 = ascending, -1 = descending) |

**Example:**
```typescript
// Sort by name ascending
const users = await collection.find({}).sort({ name: 1 }).toArray()

// Sort by multiple fields
const users = await collection.find({}).sort({ status: 1, createdAt: -1 }).toArray()
```

#### limit()

Set the maximum number of documents to return.

```typescript
limit(count: number): this
```

**Example:**
```typescript
const topTen = await collection.find({}).limit(10).toArray()
```

#### skip()

Set the number of documents to skip.

```typescript
skip(count: number): this
```

**Example:**
```typescript
// Pagination: page 2 with 10 items per page
const page2 = await collection.find({}).skip(10).limit(10).toArray()
```

#### project()

Set the projection for returned documents.

```typescript
project(spec: Record<string, 0 | 1>): this
```

**Example:**
```typescript
// Include only specific fields
const users = await collection.find({})
  .project({ name: 1, email: 1, _id: 0 })
  .toArray()
```

#### batchSize() (HttpFindCursor only)

Set the batch size for streaming (hint for server).

```typescript
batchSize(size: number): this
```

---

### Iteration Methods

#### toArray()

Execute the query and return all documents as an array.

```typescript
async toArray(): Promise<TSchema[]>
```

**Example:**
```typescript
const users = await collection.find({ status: 'active' }).toArray()
```

#### next()

Get the next document from the cursor. Returns `null` when exhausted.

```typescript
async next(): Promise<TSchema | null>
```

**Example:**
```typescript
let doc = await cursor.next()
while (doc !== null) {
  console.log(doc)
  doc = await cursor.next()
}
```

#### hasNext()

Check if there are more documents.

```typescript
async hasNext(): Promise<boolean>
```

#### forEach()

Execute a callback for each document.

```typescript
async forEach(
  callback: (doc: TSchema, index: number) => void | false | Promise<void | false>
): Promise<void>
```

Return `false` from the callback to stop iteration.

**Example:**
```typescript
await cursor.forEach((doc, index) => {
  console.log(`${index}: ${doc.name}`)
  if (index >= 10) return false // Stop after 10 documents
})
```

#### count()

Count documents in the cursor without consuming it.

```typescript
async count(): Promise<number>
```

#### map()

Transform documents with a mapping function.

```typescript
map<U>(fn: (doc: TSchema, index: number) => U): MappedCursor<TSchema, U>
```

**Example:**
```typescript
const names = await collection.find({})
  .map(doc => doc.name)
  .toArray()
```

#### close()

Close the cursor and release resources.

```typescript
async close(): Promise<void>
```

#### clone() (HttpFindCursor only)

Clone this cursor with the same options.

```typescript
clone(): HttpFindCursor<TDocument>
```

---

### Async Iteration

Cursors support `for-await-of` syntax:

```typescript
for await (const doc of collection.find({ status: 'active' })) {
  console.log(doc)
}
```

---

## AggregationCursor / HttpAggregationCursor

Cursors returned by `collection.aggregate()` for iterating over aggregation pipeline results.

### Type Parameters

```typescript
AggregationCursor<TSchema extends Document = Document>
HttpAggregationCursor<TResult extends Document = Document>
```

### Properties

#### closed

```typescript
get closed(): boolean
```

Whether the cursor is closed.

#### bufferedCount

```typescript
get bufferedCount(): number
```

Number of documents currently buffered.

#### pipeline (AggregationCursor only)

```typescript
get pipeline(): PipelineStage[]
```

Get the pipeline being executed.

---

### Iteration Methods

#### toArray()

Execute the pipeline and return all documents as an array.

```typescript
async toArray(): Promise<TResult[]>
```

**Example:**
```typescript
const results = await collection.aggregate([
  { $match: { status: 'active' } },
  { $group: { _id: '$category', count: { $sum: 1 } } }
]).toArray()
```

#### next()

Get the next document from the cursor.

```typescript
async next(): Promise<TResult | null>
```

#### hasNext()

Check if there are more documents.

```typescript
async hasNext(): Promise<boolean>
```

#### forEach()

Execute a callback for each document.

```typescript
async forEach(
  callback: (doc: TResult, index: number) => void | false | Promise<void | false>
): Promise<void>
```

#### map()

Transform documents with a mapping function.

```typescript
map<U>(fn: (doc: TResult, index: number) => U): MappedAggregationCursor<TResult, U>
```

#### close()

Close the cursor and release resources.

```typescript
async close(): Promise<void>
```

#### clone()

Clone this cursor with the same options.

```typescript
clone(): AggregationCursor<TResult>
```

#### explain()

Explain the aggregation plan (returns pipeline stages and options).

```typescript
explain(): { pipeline: AggregationStage[]; options: AggregateOptions }
```

---

### Async Iteration

Aggregation cursors also support `for-await-of`:

```typescript
for await (const doc of collection.aggregate(pipeline)) {
  console.log(doc)
}
```

---

## AggregationCursor Options

```typescript
interface AggregationCursorOptions {
  /** Batch size for streaming results */
  batchSize?: number

  /** Allow disk use for large result sets */
  allowDiskUse?: boolean

  /** Maximum time for operation (ms) */
  maxTimeMS?: number

  /** Comment for the operation */
  comment?: string
}
```

---

## Aggregation Stages

Supported aggregation stages:

### $match

Filter documents.

```typescript
{ $match: { status: 'active', age: { $gte: 18 } } }
```

### $project

Reshape documents.

```typescript
{ $project: { name: 1, fullName: { $concat: ['$firstName', ' ', '$lastName'] } } }
```

### $group

Group documents and compute aggregates.

```typescript
{ $group: {
  _id: '$category',
  count: { $sum: 1 },
  avgPrice: { $avg: '$price' },
  items: { $push: '$name' }
}}
```

**Supported Accumulators:**
- `$sum` - Sum values
- `$avg` - Average values
- `$min` - Minimum value
- `$max` - Maximum value
- `$first` - First value
- `$last` - Last value
- `$push` - Push to array
- `$addToSet` - Add unique to array
- `$count` - Count documents

### $sort

Sort documents.

```typescript
{ $sort: { createdAt: -1, name: 1 } }
```

### $limit

Limit results.

```typescript
{ $limit: 10 }
```

### $skip

Skip results.

```typescript
{ $skip: 20 }
```

### $count

Count documents.

```typescript
{ $count: 'total' }
```

### $unwind

Deconstruct arrays.

```typescript
// Simple
{ $unwind: '$tags' }

// With options
{ $unwind: { path: '$tags', preserveNullAndEmptyArrays: true } }
```

### $lookup

Join with another collection.

```typescript
{ $lookup: {
  from: 'orders',
  localField: '_id',
  foreignField: 'userId',
  as: 'userOrders'
}}
```

### $addFields / $set

Add or set fields.

```typescript
{ $addFields: {
  fullName: { $concat: ['$firstName', ' ', '$lastName'] },
  totalWithTax: { $multiply: ['$price', 1.1] }
}}
```

### $replaceRoot

Replace document root.

```typescript
{ $replaceRoot: { newRoot: '$nested.document' } }
```

### $facet

Run multiple pipelines in parallel.

```typescript
{ $facet: {
  byCategory: [
    { $group: { _id: '$category', count: { $sum: 1 } } }
  ],
  topSellers: [
    { $sort: { sales: -1 } },
    { $limit: 5 }
  ]
}}
```

---

## Expression Operators

Common expression operators for `$project`, `$addFields`, and `$group`:

### String

```typescript
{ $concat: ['$first', ' ', '$last'] }  // Concatenate strings
{ $substr: ['$field', 0, 5] }          // Substring
{ $toUpper: '$field' }                 // Uppercase
{ $toLower: '$field' }                 // Lowercase
```

### Arithmetic

```typescript
{ $add: ['$a', '$b'] }        // Addition
{ $subtract: ['$a', '$b'] }   // Subtraction
{ $multiply: ['$a', '$b'] }   // Multiplication
{ $divide: ['$a', '$b'] }     // Division
{ $round: ['$value', 2] }     // Round to decimal places
```

### Conditional

```typescript
{ $cond: { if: { $gte: ['$age', 18] }, then: 'adult', else: 'minor' } }
{ $ifNull: ['$field', 'default'] }
```

### Comparison

```typescript
{ $eq: ['$a', '$b'] }   // Equal
{ $ne: ['$a', '$b'] }   // Not equal
{ $gt: ['$a', '$b'] }   // Greater than
{ $gte: ['$a', '$b'] }  // Greater than or equal
{ $lt: ['$a', '$b'] }   // Less than
{ $lte: ['$a', '$b'] }  // Less than or equal
```

---

## Usage Examples

### Pagination

```typescript
const pageSize = 10
const page = 3

const results = await collection.find({})
  .sort({ createdAt: -1 })
  .skip((page - 1) * pageSize)
  .limit(pageSize)
  .toArray()
```

### Processing Large Datasets

```typescript
const cursor = collection.find({ status: 'pending' })

try {
  for await (const doc of cursor) {
    await processDocument(doc)
  }
} finally {
  await cursor.close()
}
```

### Complex Aggregation

```typescript
const analytics = await collection.aggregate([
  // Filter to this year
  { $match: {
    createdAt: { $gte: new Date('2024-01-01') }
  }},

  // Group by month and category
  { $group: {
    _id: {
      month: { $month: '$createdAt' },
      category: '$category'
    },
    revenue: { $sum: '$amount' },
    orders: { $sum: 1 },
    avgOrder: { $avg: '$amount' }
  }},

  // Sort by month
  { $sort: { '_id.month': 1 } },

  // Reshape output
  { $project: {
    _id: 0,
    month: '$_id.month',
    category: '$_id.category',
    revenue: { $round: ['$revenue', 2] },
    orders: 1,
    avgOrder: { $round: ['$avgOrder', 2] }
  }}
]).toArray()
```

### Transforming Results

```typescript
// Extract just the names as strings
const names = await collection.find({})
  .sort({ name: 1 })
  .map(doc => doc.name)
  .toArray()

// ['Alice', 'Bob', 'Charlie']
```

## Related

- [Collection](/docs/api-reference/collection) - Collection class reference
- [Types](/docs/api-reference/types) - TypeScript interfaces and types
